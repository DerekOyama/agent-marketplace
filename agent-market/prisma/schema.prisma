datasource db { 
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") 
}

generator client { 
  provider = "prisma-client-js" 
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  creditBalanceCents Int      @default(1000) // $10.00 in cents
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mandates      Mandate[]
  transactions  Transaction[]
}

model Agent {
  id        String   @id @default(cuid())
  name      String
  description String?
  quoteUrl  String
  runUrl    String
  token     String
  type      String   @default("legacy") // "legacy" or "n8n"
  n8nWorkflowId String?
  n8nInstanceUrl String?
  webhookUrl String?
  triggerType String? // "webhook", "manual", "schedule"
  isActive  Boolean  @default(true)
  metadata  Json?
  pricing   Json?
  stats     Json?
  inputSchema Json?   // JSON schema for input validation
  outputSchema Json?  // JSON schema for output validation
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  transactions Transaction[]
}

model Mandate {
  id        String   @id @default(cuid())
  userId    String
  rulesJson Json
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user User @relation(fields: [userId], references: [id])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  agentId     String
  amountCents Int
  currency    String   @default("USD")
  status      String   @default("pending")
  stripePi    String?
  requestJson Json?
  receiptJson Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user  User  @relation(fields: [userId], references: [id])
  agent Agent @relation(fields: [agentId], references: [id])
  logs  AuditLog[]
}

model AuditLog {
  id        String   @id @default(cuid())
  txId      String
  actor     String
  event     String
  payload   Json
  createdAt DateTime @default(now())
  transaction Transaction @relation(fields: [txId], references: [id])
}