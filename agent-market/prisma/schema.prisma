datasource db { 
  provider = "postgresql"
  url      = env("DATABASE_URL") 
}

generator client { 
  provider = "prisma-client-js" 
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mandates      Mandate[]
  transactions  Transaction[]
}

model Agent {
  id        String   @id @default(cuid())
  name      String
  quoteUrl  String
  runUrl    String
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  transactions Transaction[]
}

model Mandate {
  id        String   @id @default(cuid())
  userId    String
  rulesJson Json
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user User @relation(fields: [userId], references: [id])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  agentId     String
  amountCents Int
  currency    String   @default("USD")
  status      String   @default("pending")
  stripePi    String?
  requestJson Json?
  receiptJson Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user  User  @relation(fields: [userId], references: [id])
  agent Agent @relation(fields: [agentId], references: [id])
  logs  AuditLog[]
}

model AuditLog {
  id        String   @id @default(cuid())
  txId      String
  actor     String
  event     String
  payload   Json
  createdAt DateTime @default(now())
  transaction Transaction @relation(fields: [txId], references: [id])
}